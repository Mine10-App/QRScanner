<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Barcode Scanner with Firebase</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body {
    background: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  #reader {
    width: 100%;
    max-width: 400px;
    position: relative;
    margin: 0 auto;
    border: 2px solid black;
  }
  /* Red scanning line */
  #scan-line {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: red;
    animation: scan 2s linear infinite;
  }
  @keyframes scan {
    0% { top: 0; }
    50% { top: 95%; }
    100% { top: 0; }
  }
  #result {
    margin-top: 10px;
    font-weight: bold;
    color: green;
  }
</style>
</head>
<body>

<h2>Web Barcode Scanner with Firebase</h2>

<div id="reader">
  <div id="scan-line"></div>
</div>
<div id="result">No result yet</div>

<script>
  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5G36djlzBuhNEzKzrvcJ_1-qvrTm1bOs",
    authDomain: "qr-scanner-live-5b385.firebaseapp.com",
    projectId: "qr-scanner-live-5b385",
    storageBucket: "qr-scanner-live-5b385.firebasestorage.app",
    messagingSenderId: "260207453177",
    appId: "1:260207453177:web:ea438ade7b1b56270e1328",
    measurementId: "G-WQEEHEPWG3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const existingCodes = new Set();

  // Load existing codes from Firebase
  db.collection("scans").get().then(snapshot => {
    snapshot.forEach(doc => {
      if(doc.data().code) existingCodes.add(doc.data().code);
    });
  });

  // ===== HTML5-QRCODE SETUP =====
  const html5QrCode = new Html5Qrcode("reader");

  const config = {
    fps: 10,
    qrbox: { width: 300, height: 300 },
    experimentalFeatures: { useBarCodeDetectorIfSupported: true } // sharper scanning
  };

  html5QrCode.start(
    { facingMode: "environment" }, // rear camera
    config,
    decodedText => {
      if(!existingCodes.has(decodedText)){
        existingCodes.add(decodedText);

        // Save to Firebase
        db.collection("scans").add({
          code: decodedText,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          copied: false
        });

        document.getElementById("result").textContent = "✅ Saved: " + decodedText;
      } else {
        document.getElementById("result").textContent = "⚠ Already exists: " + decodedText;
      }
    },
    errorMessage => {
      // You can ignore decode errors, no need to spam console
    }
  ).catch(err => {
    console.error("Camera initialization error:", err);
    document.getElementById("result").textContent = "Camera access denied or unavailable.";
  });
</script>

</body>
</html>
