<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Barcode Scanner with Firebase</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<style>
  body { background:white; font-family: Arial; text-align:center; margin:0; padding:20px; }
  #video-container { position: relative; display:inline-block; width:100%; max-width:400px; margin:20px auto; }
  video { width:100%; border:2px solid black; }
  #scan-line { position:absolute; top:0; left:0; width:100%; height:2px; background:red; animation:scan 2s linear infinite; }
  @keyframes scan {0%{top:0;}50%{top:95%;}100%{top:0;}}
  select, button { margin:10px; padding:8px 16px; font-size:16px; }
  #result { margin-top:10px; font-weight:bold; color:green; }
</style>
</head>
<body>

<h2>Web Barcode Scanner with Firebase</h2>

<select id="cameraSelect"></select>
<button id="startBtn">Start Scanning</button>
<button id="saveBtn" disabled>Save Barcode</button>

<div id="video-container">
  <video id="video" autoplay playsinline></video>
  <div id="scan-line"></div>
</div>

<div id="result">No result yet</div>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5G36djlzBuhNEzKzrvcJ_1-qvrTm1bOs",
    authDomain: "qr-scanner-live-5b385.firebaseapp.com",
    projectId: "qr-scanner-live-5b385",
    storageBucket: "qr-scanner-live-5b385.firebasestorage.app",
    messagingSenderId: "260207453177",
    appId: "1:260207453177:web:ea438ade7b1b56270e1328",
    measurementId: "G-WQEEHEPWG3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const video = document.getElementById('video');
  const cameraSelect = document.getElementById('cameraSelect');
  const startBtn = document.getElementById('startBtn');
  const saveBtn = document.getElementById('saveBtn');
  const resultDiv = document.getElementById('result');
  const existingCodes = new Set();
  let currentCode = "";

  const codeReader = new ZXing.BrowserMultiFormatReader();

  // Load existing codes from Firebase
  db.collection("scans").get().then(snapshot => {
    snapshot.forEach(doc => {
      if(doc.data().code) existingCodes.add(doc.data().code);
    });
  });

  // Populate camera options (request permission first)
  async function populateCameras() {
    try {
      await navigator.mediaDevices.getUserMedia({ video: true });
      const devices = await codeReader.listVideoInputDevices();
      devices.forEach((device,i)=>{
        const option = new Option(device.label || `Camera ${i+1}`, device.deviceId);
        cameraSelect.appendChild(option);
      });
      // Prefer rear/back camera if available
      for(const dev of devices){
        if(dev.label.toLowerCase().includes("back") || dev.label.toLowerCase().includes("rear")){
          cameraSelect.value = dev.deviceId;
          break;
        }
      }
    } catch(err){
      alert("Camera access denied or not available");
    }
  }
  populateCameras();

  // Start scanning
  startBtn.addEventListener('click', ()=>{
    const deviceId = cameraSelect.value;
    if(!deviceId){ alert("Select a camera first"); return; }
    resultDiv.textContent = "Scanning...";
    codeReader.reset();

    codeReader.decodeFromVideoDevice(deviceId, video, (result, err)=>{
      if(result){
        currentCode = result.getText();
        if(existingCodes.has(currentCode)){
          resultDiv.textContent = "⚠ Already exists: " + currentCode;
          saveBtn.disabled = true;
        } else {
          resultDiv.textContent = "✅ Scanned: " + currentCode;
          saveBtn.disabled = false;
        }
      }
    }).catch(err=>{
      console.error(err);
      resultDiv.textContent = "Camera error";
    });
  });

  // Save scanned code to Firebase
  saveBtn.addEventListener('click', ()=>{
    if(!currentCode) return;
    if(existingCodes.has(currentCode)) return;
    existingCodes.add(currentCode);
    db.collection("scans").add({
      code: currentCode,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      copied:false
    });
    resultDiv.textContent = "✅ Saved: " + currentCode;
    saveBtn.disabled = true;
    currentCode = "";
  });
</script>

</body>
</html>
