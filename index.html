<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auto Barcode Scanner with Firebase</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/@zxing/browser@latest"></script>
<style>
  body { background:white; font-family: Arial; text-align:center; margin:0; padding:20px; }
  #video-container { position: relative; display:inline-block; width:100%; max-width:400px; margin:20px auto; }
  video { width:100%; border:2px solid black; }
  #scan-line { position:absolute; top:0; left:0; width:100%; height:2px; background:red; animation:scan 2s linear infinite; }
  @keyframes scan {0%{top:0;}50%{top:95%;}100%{top:0;}}
  select { margin:10px; padding:8px 16px; font-size:16px; }
  #result { margin-top:10px; font-weight:bold; color:green; }
</style>
</head>
<body>

<h2>Auto Barcode Scanner with Firebase</h2>

<select id="cameraSelect"></select>

<div id="video-container">
  <video id="video" autoplay playsinline></video>
  <div id="scan-line"></div>
</div>

<div id="result">Initializing...</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5G36djlzBuhNEzKzrvcJ_1-qvrTm1bOs",
    authDomain: "qr-scanner-live-5b385.firebaseapp.com",
    projectId: "qr-scanner-live-5b385",
    storageBucket: "qr-scanner-live-5b385.firebasestorage.app",
    messagingSenderId: "260207453177",
    appId: "1:260207453177:web:ea438ade7b1b56270e1328",
    measurementId: "G-WQEEHEPWG3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const video = document.getElementById('video');
  const cameraSelect = document.getElementById('cameraSelect');
  const resultDiv = document.getElementById('result');
  const beep = document.getElementById('beep');

  const existingCodes = new Set();
  let currentCode = "";
  const codeReader = new ZXing.BrowserMultiFormatReader();

  // Load existing codes from Firebase
  db.collection("scans").get().then(snapshot => {
    snapshot.forEach(doc => {
      if(doc.data().code) existingCodes.add(doc.data().code);
    });
  });

  async function initCameras() {
    try {
      // Request permission
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      stream.getTracks().forEach(track => track.stop());

      const devices = await codeReader.listVideoInputDevices();
      if(devices.length === 0){ alert("No camera found!"); return; }

      cameraSelect.innerHTML = "";
      devices.forEach((dev,i)=>{
        const option = new Option(dev.label || `Camera ${i+1}`, dev.deviceId);
        cameraSelect.appendChild(option);
      });

      // Prefer rear camera
      let rearDevice = devices.find(d => d.label.toLowerCase().includes("back") || d.label.toLowerCase().includes("rear"));
      if(rearDevice) cameraSelect.value = rearDevice.deviceId;

      startScanner(cameraSelect.value);
    } catch(err){
      console.error(err);
      resultDiv.textContent = "Camera access denied or unavailable.";
    }
  }

  async function startScanner(deviceId){
    codeReader.reset();
    resultDiv.textContent = "Scanning...";
    codeReader.decodeFromVideoDevice(deviceId, video, (result, err)=>{
      if(result){
        const code = result.getText();
        if(!existingCodes.has(code)){
          existingCodes.add(code);
          currentCode = code;

          // Save automatically to Firebase
          db.collection("scans").add({
            code: code,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            copied:false
          });

          // Beep + flash effect
          beep.play();
          flashScreen();
          resultDiv.textContent = "✅ Saved: " + code;
        } else {
          resultDiv.textContent = "⚠ Already exists: " + code;
        }
      }
    }).catch(err=>{
      console.error(err);
      resultDiv.textContent = "Camera error.";
    });
  }

  function flashScreen(){
    document.body.style.background = "#ffff99";
    setTimeout(()=>{ document.body.style.background = "white"; },100);
  }

  cameraSelect.addEventListener('change', ()=>{
    startScanner(cameraSelect.value);
  });

  // Auto initialize cameras
  initCameras();
</script>

</body>
</html>
