<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live QR Code Display</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    h2 { text-align: center; margin-bottom: 20px; }
    #scan-list { 
      display: grid;
      grid-template-columns: 3fr 1.5fr 1fr 1fr;
      gap: 10px;
      align-items: center;
      max-width: 1000px;
      margin: auto;
    }
    .scan-item { display: contents; }
    .cell {
      padding: 6px;
      background: #f0f0f0;
      border-radius: 5px;
      word-break: break-all;
      font-size: 12px;
    }
    button {
      padding: 4px 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 12px;
    }
    .copy-btn { background: #007bff; color: white; }
    .copy-btn.copied { background: #28a745; }
    .delete-btn { background: #dc3545; color: white; }
    .header { font-weight: bold; background: #ccc; font-size: 12px; }
  </style>
</head>
<body>

<h2>Live Scans (Today Only)</h2>
<div id="scan-list">
  <div class="cell header">Code</div>
  <div class="cell header">Timestamp</div>
  <div class="cell header">Copy</div>
  <div class="cell header">Delete</div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC5G36djlzBuhNEzKzrvcJ_1-qvrTm1bOs",
    authDomain: "qr-scanner-live-5b385.firebaseapp.com",
    projectId: "qr-scanner-live-5b385",
    storageBucket: "qr-scanner-live-5b385.firebasestorage.app",
    messagingSenderId: "260207453177",
    appId: "1:260207453177:web:ea438ade7b1b56270e1328",
    measurementId: "G-WQEEHEPWG3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const scanList = document.getElementById("scan-list");

  // Get today's start and end
  const now = new Date();
  const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const endOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

  // ðŸ”¹ Auto-delete all old scans (before today)
  async function deleteOldScans() {
    const oldDocs = await db.collection("scans")
      .where("timestamp", "<", startOfDay)
      .get();

    oldDocs.forEach(doc => {
      db.collection("scans").doc(doc.id).delete()
        .then(() => console.log("Deleted old scan:", doc.id))
        .catch(err => console.error("Delete failed", err));
    });
  }

  deleteOldScans(); // Run once on page load

  // ðŸ”¹ Live listener for only today's scans
  db.collection("scans")
    .where("timestamp", ">=", startOfDay)
    .where("timestamp", "<", endOfDay)
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      scanList.querySelectorAll(".scan-item").forEach(el => el.remove());

      snapshot.forEach(doc => {
        const data = doc.data();
        if (!data || !data.code) return;

        const code = data.code;
        const ts = data.timestamp?.toDate().toLocaleString() || "";

        const row = document.createElement("div");
        row.classList.add("scan-item");

        // Code cell
        const codeCell = document.createElement("div");
        codeCell.classList.add("cell");
        codeCell.textContent = code;

        // Timestamp cell
        const tsCell = document.createElement("div");
        tsCell.classList.add("cell");
        tsCell.textContent = ts;

        // Copy button
        const copyCell = document.createElement("div");
        copyCell.classList.add("cell");
        const copyBtn = document.createElement("button");
        copyBtn.classList.add("copy-btn");
        copyBtn.textContent = data.copied ? "Copied!" : "Copy";
        if (data.copied) copyBtn.classList.add("copied");

        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(code);
            await db.collection("scans").doc(doc.id).update({ copied: true });
            copyBtn.textContent = "Copied!";
            copyBtn.classList.add("copied");
          } catch (err) {
            console.error(err);
          }
        });
        copyCell.appendChild(copyBtn);

        // Delete button
        const deleteCell = document.createElement("div");
        deleteCell.classList.add("cell");
        const deleteBtn = document.createElement("button");
        deleteBtn.classList.add("delete-btn");
        deleteBtn.textContent = "Delete";

        deleteBtn.addEventListener("click", async () => {
          if (confirm(`Delete scan "${code}"?`)) {
            await db.collection("scans").doc(doc.id).delete();
          }
        });
        deleteCell.appendChild(deleteBtn);

        row.appendChild(codeCell);
        row.appendChild(tsCell);
        row.appendChild(copyCell);
        row.appendChild(deleteCell);

        scanList.appendChild(row);
      });
    });
</script>

</body>
</html>
