<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Accepted Requests</title>
<link rel="stylesheet" href="style.css">
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #f2f2f2; }
  button { padding: 4px 8px; margin: 2px; cursor: pointer; }
  .filters { margin: 10px 0; }
</style>
</head>
<body>
<h2>Accepted Requests</h2>

<div class="filters">
  <label>Date: <input type="date" id="filterDate"></label>
  <label>Request Staff: <input type="text" id="filterStaff" placeholder="Name"></label>
  <button onclick="loadAcceptedRequests()">Apply Filter</button>
</div>

<table>
  <thead>
    <tr>
      <th>Request Staff</th>
      <th>Recipient</th>
      <th>Date</th>
      <th>Duty Time</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="requestsTable">
    <tr><td colspan="6">Loading...</td></tr>
  </tbody>
</table>

<!-- ‚úÖ Firebase SDKs in correct order -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="sca.js"></script> <!-- must have firebase.initializeApp(config) -->

<script>
  const db = firebase.firestore();

  function loadAcceptedRequests() {
    const tableBody = document.getElementById("requestsTable");
    const filterDate = document.getElementById("filterDate").value;
    const filterStaff = document.getElementById("filterStaff").value.toLowerCase();

    tableBody.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

    db.collection("dutyRequests").where("status", "==", "accepted").get()
      .then(snapshot => {
        if (snapshot.empty) {
          console.log("‚ö†Ô∏è No documents found with status = accepted");
          tableBody.innerHTML = "<tr><td colspan='6'>No accepted requests found.</td></tr>";
          return;
        }

        let rows = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("üìÑ Doc:", doc.id, data); // Debug log

          // Safe field handling
          const requestDate = data.date instanceof firebase.firestore.Timestamp
            ? data.date.toDate().toISOString().split("T")[0]
            : (data.date || "");
          const staffName = (data.requestedStaff || "").toLowerCase();

          // Apply filters
          if ((filterDate && filterDate !== requestDate) ||
              (filterStaff && !staffName.includes(filterStaff))) return;

          rows += `
            <tr>
              <td>${data.requestedStaff || ""}</td>
              <td>${data.recipient || ""}</td>
              <td>${requestDate}</td>
              <td>${data.dutyTime || ""}</td>
              <td>${data.status || ""}</td>
              <td>
                ${data.applied ? 'Applied' : `<button onclick="markApplied('${doc.id}')">Apply</button>`}
                <button onclick="deleteRequest('${doc.id}')" ${data.applied ? 'disabled' : ''}>Delete</button>
              </td>
            </tr>
          `;
        });

        tableBody.innerHTML = rows || "<tr><td colspan='6'>No accepted requests found (after filters).</td></tr>";
      })
      .catch(err => {
        console.error("‚ùå Error fetching requests:", err);
        tableBody.innerHTML = "<tr><td colspan='6'>Error loading requests.</td></tr>";
      });
  }

  function markApplied(id) {
    db.collection("dutyRequests").doc(id).update({ applied: true })
      .then(() => loadAcceptedRequests())
      .catch(err => console.error("‚ùå Error updating:", err));
  }

  function deleteRequest(id) {
    db.collection("dutyRequests").doc(id).delete()
      .then(() => loadAcceptedRequests())
      .catch(err => console.error("‚ùå Error deleting:", err));
  }

  // Initial load
  loadAcceptedRequests();
</script>
</body>
</html>