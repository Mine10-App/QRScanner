<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Accepted Requests</title>
<link rel="stylesheet" href="style.css">
<style>
  .small-btn { padding: 4px 8px; font-size: 0.8rem; margin-right: 5px; }
  .delete { background-color: #f44336; color: white; }
  .apply { background-color: #4CAF50; color: white; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>
<body>
<div class="form-container">
  <h2>Accepted Requests</h2>
  <div class="top-buttons">
    <button class="small-btn" onclick="goToDashboard()">Dashboard</button>
    <button class="small-btn" onclick="logout()">Logout</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>From</th>
        <th>To</th>
        <th>Date</th>
        <th>Duty Time</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="acceptedRequests"></tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="sca.js"></script>

<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = localStorage.getItem("currentUser");
if (!currentUser) {
  alert("Please login first!");
  window.location.href = "login.html";
}

function goToDashboard() {
  window.location.href = "dashboard.html";
}

function logout() {
  localStorage.removeItem("currentUser");
  localStorage.removeItem("currentRCNo");
  window.location.href = "login.html";
}

// Load accepted requests
function loadAcceptedRequests() {
  const container = document.getElementById("acceptedRequests");
  container.innerHTML = "<tr><td colspan='6'>Loading...</td></tr>";

  db.collection("dutyRequests")
    .where("status", "==", "accepted")
    .orderBy("date")
    .get()
    .then(snapshot => {
      let html = "";
      snapshot.forEach(doc => {
        const req = doc.data();
        const id = doc.id;

        html += `
          <tr>
            <td>${req.requestedStaff}</td>
            <td>${req.recipient}</td>
            <td>${req.date}</td>
            <td>${req.dutyTime}</td>
            <td>${req.applied ? "Applied" : req.status}</td>
            <td>
              ${!req.applied ? `<button class="small-btn apply" onclick="applyRequest('${id}')">Apply</button>
              <button class="small-btn delete" onclick="deleteRequest('${id}')">Delete</button>` : ""}
            </td>
          </tr>
        `;
      });

      container.innerHTML = html || "<tr><td colspan='6'>No accepted requests.</td></tr>";
    });
}

// Apply request
function applyRequest(id) {
  db.collection("dutyRequests").doc(id).update({ applied: true }).then(() => {
    alert("Request applied successfully!");
    loadAcceptedRequests();
  });
}

// Delete request
function deleteRequest(id) {
  if(confirm("Are you sure you want to delete this request?")) {
    db.collection("dutyRequests").doc(id).delete().then(() => {
      loadAcceptedRequests();
    });
  }
}

loadAcceptedRequests();
</script>
</body>
</html>
