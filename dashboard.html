<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #f2f2f2;
  }
  .top-buttons {
    margin-bottom: 20px;
  }
  /* Button styling */
  .action-btn {
    padding: 3px 8px;
    margin: 0 2px;
    font-size: 0.85em;
    border: none;
    border-radius: 3px;
    cursor: pointer;
  }
  .accept-btn { background-color: #4CAF50; color: white; }
  .reject-btn { background-color: #f44336; color: white; }
</style>
</head>
<body>
<div class="form-container">
  <h2>Welcome, <span id="userName"></span></h2>

  <div class="top-buttons">
    <button onclick="goToDutyChange()">Request Duty Change</button>
    <button onclick="logout()">Logout</button>
  </div>

  <h3>Requests Assigned To You</h3>
  <table id="incomingRequestsTable">
    <thead>
      <tr>
        <th>From</th>
        <th>Date</th>
        <th>Duty Time</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>

  <h3>Requests Sent By You</h3>
  <table id="sentRequestsTable">
    <thead>
      <tr>
        <th>To</th>
        <th>Date</th>
        <th>Duty Time</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="sca.js"></script>
<script>


firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = localStorage.getItem("currentUser");
if(!currentUser){
  alert("Please login first!");
  window.location.href = "login.html";
} else {
  document.getElementById("userName").innerText = currentUser;
}

function goToDutyChange(){ window.location.href = "dutychange.html"; }
function logout(){ localStorage.clear(); window.location.href = "login.html"; }

function loadRequests() {
  const incomingBody = document.querySelector("#incomingRequestsTable tbody");
  const sentBody = document.querySelector("#sentRequestsTable tbody");

  db.collection("dutyRequests").orderBy("timestamp", "desc").get()
    .then(snapshot => {
      incomingBody.innerHTML = "";
      sentBody.innerHTML = "";

      snapshot.forEach(doc => {
        const req = doc.data();
        const reqId = doc.id;

        // Incoming requests
        if(req.recipient === currentUser){
          const actions = req.status==="pending" 
            ? `<button class="action-btn accept-btn" onclick="updateRequest('${reqId}','accepted')">Accept</button>
               <button class="action-btn reject-btn" onclick="updateRequest('${reqId}','rejected')">Reject</button>` 
            : "";
          incomingBody.innerHTML += `<tr>
            <td>${req.requestedStaff}</td>
            <td>${req.date}</td>
            <td>${req.dutyTime}</td>
            <td>${req.status}</td>
            <td>${actions}</td>
          </tr>`;
        }

        // Sent requests
        if(req.requestedStaff === currentUser){
          sentBody.innerHTML += `<tr>
            <td>${req.recipient}</td>
            <td>${req.date}</td>
            <td>${req.dutyTime}</td>
            <td>${req.status}</td>
          </tr>`;
        }
      });

      if(incomingBody.innerHTML === "") incomingBody.innerHTML = "<tr><td colspan='5'>No pending requests.</td></tr>";
      if(sentBody.innerHTML === "") sentBody.innerHTML = "<tr><td colspan='4'>No requests sent.</td></tr>";
    });
}

function updateRequest(id, status){
  db.collection("dutyRequests").doc(id).update({status})
    .then(() => loadRequests());
}

loadRequests();
</script>
</body>
</html>
