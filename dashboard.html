<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
  .ribbon-button { padding: 4px 8px; font-size: 14px; margin-right: 5px; }
  .accept-btn { background-color: #4CAF50; color: white; border: none; padding: 4px 8px; cursor: pointer; }
  .reject-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; cursor: pointer; }
  .cancel-btn { background-color: #777; color: white; border: none; padding: 4px 8px; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
</style>
</head>
<body>
<div class="form-container">
  <h2>Welcome, <span id="userName"></span></h2>
  <div class="top-buttons">
    <button class="ribbon-button" onclick="goToDutyChange()">Request Duty Change</button>
    <button class="ribbon-button" onclick="logout()">Logout</button>
  </div>

  <h3>Requests Assigned To You</h3>
  <div id="incomingRequests"><p>Loading...</p></div>

  <h3>Requests Sent By You</h3>
  <div id="sentRequests"><p>Loading...</p></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- Include Firebase config -->
<script src="sca.js"></script>

<script>
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Get current user from localStorage
  const currentUser = localStorage.getItem("currentUser");
  const currentRCNo = localStorage.getItem("currentRCNo");

  if (!currentUser) {
    alert("Please login first!");
    window.location.href = "login.html";
  } else {
    document.getElementById("userName").innerText = currentUser;
  }

  function goToDutyChange() {
    window.location.href = "dutychange.html";
  }

  function logout() {
    localStorage.removeItem("currentUser");
    localStorage.removeItem("currentRCNo");
    window.location.href = "login.html";
  }

  function loadRequests() {
    const incomingContainer = document.getElementById("incomingRequests");
    const sentContainer = document.getElementById("sentRequests");

    incomingContainer.innerHTML = "<p>Loading...</p>";
    sentContainer.innerHTML = "<p>Loading...</p>";

    db.collection("dutyRequests").orderBy("timestamp", "desc").get()
      .then(snapshot => {
        let incomingHTML = "";
        let sentHTML = "";

        snapshot.forEach(doc => {
          const req = doc.data();
          const reqId = doc.id;

          if (req.recipient === currentUser) {
            incomingHTML += `
              <tr>
                <td>${req.requestedStaff}</td>
                <td>${req.date}</td>
                <td>${req.dutyTime}</td>
                <td>${req.status}</td>
                <td>
                  ${req.status === "pending" ? `<button class="accept-btn" onclick="acceptRequest('${reqId}')">Accept</button>
                  <button class="reject-btn" onclick="rejectRequest('${reqId}')">Reject</button>` : ""}
                </td>
              </tr>`;
          }

          if (req.requestedStaff === currentUser) {
            sentHTML += `
              <tr>
                <td>${req.recipient}</td>
                <td>${req.date}</td>
                <td>${req.dutyTime}</td>
                <td>${req.status}</td>
                <td><button class="cancel-btn" onclick="cancelRequest('${reqId}')">Cancel</button></td>
              </tr>`;
          }
        });

        incomingContainer.innerHTML = `<table>
          <tr><th>From</th><th>Date</th><th>Duty Time</th><th>Status</th><th>Actions</th></tr>${incomingHTML || "<tr><td colspan='5'>No pending requests.</td></tr>"}</table>`;

        sentContainer.innerHTML = `<table>
          <tr><th>To</th><th>Date</th><th>Duty Time</th><th>Status</th><th>Actions</th></tr>${sentHTML || "<tr><td colspan='5'>No requests sent.</td></tr>"}</table>`;
      });
  }

  function acceptRequest(id) {
    db.collection("dutyRequests").doc(id).update({ status: "accepted" }).then(loadRequests);
  }

  function rejectRequest(id) {
    db.collection("dutyRequests").doc(id).update({ status: "rejected" }).then(loadRequests);
  }

  function cancelRequest(id) {
    db.collection("dutyRequests").doc(id).delete().then(loadRequests);
  }

  // Initial load
  loadRequests();
</script>
</body>
</html>
