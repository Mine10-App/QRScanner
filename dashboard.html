<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="form-container">
  <h2>Welcome, <span id="userName"></span></h2>

  <div class="top-buttons">
    <button class="ribbon-button" onclick="goToDutyChange()">Request Duty Change</button>
    <button class="ribbon-button" onclick="logout()">Logout</button>
  </div>

  <h3>Requests Assigned To You</h3>
  <div id="incomingRequests"><p>Loading...</p></div>

  <h3>Requests Sent By You</h3>
  <div id="sentRequests"><p>Loading...</p></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDvHKlApQ4wClz-y0ejSG91ahKBWvPCSM0",
  authDomain: "leeli-37413.firebaseapp.com",
  projectId: "leeli-37413",
  storageBucket: "leeli-37413.firebasestorage.app",
  messagingSenderId: "1055234470933",
  appId: "1:1055234470933:web:a7c063c08dbb21d94e8a1c",
  measurementId: "G-LMKVKWY3TB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = localStorage.getItem("currentUser");
if(!currentUser){
  alert("Please login first!");
  window.location.href = "login.html";
} else {
  document.getElementById("userName").innerText = currentUser;
}

function goToDutyChange(){ window.location.href = "dutychange.html"; }
function logout(){ localStorage.clear(); window.location.href = "login.html"; }

function loadRequests(){
  const incomingContainer = document.getElementById("incomingRequests");
  const sentContainer = document.getElementById("sentRequests");

  incomingContainer.innerHTML = "<p>Loading...</p>";
  sentContainer.innerHTML = "<p>Loading...</p>";

  db.collection("dutyRequests").orderBy("timestamp", "desc").get()
    .then(snapshot => {
      let incomingHTML = "";
      let sentHTML = "";

      snapshot.forEach(doc => {
        const req = doc.data();
        const reqId = doc.id;

        if(req.recipient === currentUser){
          incomingHTML += `<div class="request-card">
            <p><strong>From:</strong> ${req.requestedStaff}</p>
            <p><strong>Date:</strong> ${req.date}</p>
            <p><strong>Duty Time:</strong> ${req.dutyTime}</p>
            <p><strong>Status:</strong> ${req.status}</p>
            ${req.status==="pending" ? `<button onclick="updateRequest('${reqId}','accepted')">Accept</button>
            <button onclick="updateRequest('${reqId}','rejected')">Reject</button>` : ""}
            <hr></div>`;
        }

        if(req.requestedStaff === currentUser){
          sentHTML += `<div class="request-card">
            <p><strong>To:</strong> ${req.recipient}</p>
            <p><strong>Date:</strong> ${req.date}</p>
            <p><strong>Duty Time:</strong> ${req.dutyTime}</p>
            <p><strong>Status:</strong> ${req.status}</p><hr></div>`;
        }
      });

      incomingContainer.innerHTML = incomingHTML || "<p>No pending requests.</p>";
      sentContainer.innerHTML = sentHTML || "<p>No requests sent.</p>";
    });
}

function updateRequest(id, status){
  db.collection("dutyRequests").doc(id).update({status})
    .then(() => loadRequests());
}

loadRequests();
</script>
</body>
</html>
