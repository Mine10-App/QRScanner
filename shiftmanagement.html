<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shift Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="fire2.js"></script> <!-- Firebase config -->
<script src="users.js"></script> <!-- users array -->
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; min-height: 100vh; color: #212529; }
.container { max-width: 900px; margin: 0 auto; }
.header { text-align: center; margin-bottom: 20px; }
.header h1 { color: #4361ee; }
.shift-info { text-align: center; margin-bottom: 20px; font-size: 18px; }
.buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; color: white; }
#openShiftBtn { background: #28a745; }
#closeShiftBtn { background: #dc3545; }
#openShiftBtn:disabled, #closeShiftBtn:disabled { background: #888; cursor: not-allowed; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 10px; border: 1px solid #dee2e6; text-align: left; }
th { background: #f8f9fa; }
</style>
</head>
<body>
<div class="container">
  <div class="header"><h1>Shift Management</h1></div>
  <div class="shift-info" id="currentShiftInfo"> Loading current shift... </div>
  <div class="buttons">
    <button id="openShiftBtn">Open Shift</button>
    <button id="closeShiftBtn">Close Shift</button>
  </div>
  <table id="shiftsTable">
    <thead>
      <tr>
        <th>Shift No</th>
        <th>Status</th>
        <th>User</th>
        <th>Start Time</th>
        <th>End Time</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5" style="text-align:center;">Loading shifts...</td></tr>
    </tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
window.addEventListener('load', async () => {
  if (typeof firebaseConfig === 'undefined') { alert("Firebase config not found in fire2.js"); return; }
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const currentShiftInfo = document.getElementById("currentShiftInfo");
  const openBtn = document.getElementById("openShiftBtn");
  const closeBtn = document.getElementById("closeShiftBtn");
  const shiftsTableBody = document.querySelector("#shiftsTable tbody");

  let currentShift = null;
  const maxShifts = 2;

  // Prompt user login (simulate login)
  let currentUser = prompt("Enter your username:");
  if (!users.find(u => u.username === currentUser)) {
    alert("User not found! Defaulting to Koveli.");
    currentUser = "Koveli";
  }

  async function loadShifts() {
    const snapshot = await db.collection("shifts").orderBy("shiftNo").get();
    const shifts = [];
    snapshot.forEach(doc => shifts.push({ id: doc.id, ...doc.data() }));
    renderShifts(shifts);
    currentShift = shifts.find(s => s.status === "open") || null;
    updateShiftInfo(shifts);
  }

  function renderShifts(shifts) {
    if (shifts.length === 0) {
      shiftsTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No shifts found</td></tr>`;
      return;
    }
    shiftsTableBody.innerHTML = "";
    shifts.forEach(shift => {
      const start = shift.startTime ? new Date(shift.startTime.seconds * 1000).toLocaleString() : "-";
      const end = shift.endTime ? new Date(shift.endTime.seconds * 1000).toLocaleString() : "-";
      shiftsTableBody.innerHTML += `<tr>
        <td>${shift.shiftNo}</td>
        <td>${shift.status}</td>
        <td>${shift.user}</td>
        <td>${start}</td>
        <td>${end}</td>
      </tr>`;
    });
  }

  function updateShiftInfo(shifts) {
    const shift1 = shifts.find(s => s.shiftNo === 1) || null;
    const shift2 = shifts.find(s => s.shiftNo === 2) || null;

    if (currentShift) {
      currentShiftInfo.textContent = `Current Shift: ${currentShift.shiftNo} | Status: ${currentShift.status} | User: ${currentShift.user}`;
      openBtn.disabled = true;
      closeBtn.disabled = false;
    } else {
      // Determine which shift can open
      if (!shift1) { openBtn.disabled = false; } 
      else if (shift1 && shift1.status === "closed" && !shift2) { openBtn.disabled = false; } 
      else { openBtn.disabled = true; }
      closeBtn.disabled = true;
      currentShiftInfo.textContent = "No shift is currently open.";
    }
  }

  async function promptSupervisor() {
    const username = prompt("Supervisor username:");
    const password = prompt("Supervisor password:");
    const supervisor = users.find(u => u.Level === "Supervisor" && u.username === username && u.password === password);
    if (!supervisor) {
      alert("Invalid supervisor credentials!");
      return false;
    }
    return true;
  }

  openBtn.addEventListener("click", async () => {
    const snapshot = await db.collection("shifts").orderBy("shiftNo").get();
    const shifts = [];
    snapshot.forEach(doc => shifts.push({ id: doc.id, ...doc.data() }));

    let nextShiftNo = 1;
    if (shifts.length > 0) nextShiftNo = shifts.length + 1;

    if (nextShiftNo > maxShifts) { alert("Only 2 shifts allowed per day."); return; }

    // Check if shift exists and is closed (reopening)
    const existingShift = shifts.find(s => s.shiftNo === nextShiftNo && s.status === "closed");
    if (existingShift) {
      const ok = await promptSupervisor();
      if (!ok) return;  // stop if wrong credentials
    }

    await db.collection("shifts").add({
      shiftNo: nextShiftNo,
      status: "open",
      user: currentUser,
      startTime: firebase.firestore.FieldValue.serverTimestamp(),
      endTime: null
    });
    await loadShifts();
    alert(`Shift ${nextShiftNo} opened`);
  });

  closeBtn.addEventListener("click", async () => {
    if (!currentShift) return;
    await db.collection("shifts").doc(currentShift.id).update({
      status: "closed",
      endTime: firebase.firestore.FieldValue.serverTimestamp()
    });
    await loadShifts();
    alert(`Shift ${currentShift.shiftNo} closed`);
  });

  // Load initial shifts
  loadShifts();

  // Live updates
  db.collection("shifts").orderBy("shiftNo").onSnapshot(snapshot => {
    const shifts = [];
    snapshot.forEach(doc => shifts.push({ id: doc.id, ...doc.data() }));
    renderShifts(shifts);
    currentShift = shifts.find(s => s.status === "open") || null;
    updateShiftInfo(shifts);
  });
});
</script>
</body>
</html>
