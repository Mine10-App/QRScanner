<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ... Your existing CSS remains unchanged ... */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-clock"></i> Shift Management System</h1>
            <p id="current-date">Current Date: Loading...</p>
            <div id="current-shift-indicator" class="current-shift-indicator" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <span id="current-shift-text">No Active Shift</span>
            </div>
        </header>
        
        <div class="dashboard">
            <!-- ... Shift cards remain unchanged ... -->
        </div>
        
        <div class="firebase-status">
            <i id="firebase-status-icon" class="fas fa-plug disconnected"></i>
            <span id="firebase-status-text">Firebase not connected - Using localStorage</span>
        </div>
        
        <div class="firebase-setup" id="firebase-setup">
            <h2 class="setup-title">Firebase Setup Instructions</h2>
            <ol class="setup-steps">
                <li>Create a Firebase project at <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                <li>Enable Firestore Database in your Firebase project</li>
                <li>Replace the Firebase configuration below with your own details</li>
            </ol>
        </div>
        
        <div class="shift-history">
            <!-- ... History section remains unchanged ... -->
        </div>
    </div>
    
    <!-- Modal for password entry -->
    <div id="password-modal" class="modal">
        <!-- ... Modal content remains unchanged ... -->
    </div>

    <!-- Your Firebase Config (real keys inside fire3.js) -->
    <script src="fire3.js"></script>

    <script>
        // Use the globals from fire3.js
        // db -> Firestore instance
        // firebaseConnected -> connection flag

        // System state
        const state = {
            shifts: {
                shift1: { 
                    id: 1, 
                    name: "Shift 1 (Morning)", 
                    open: false, 
                    openTime: null, 
                    closeTime: null,
                    openedToday: false,
                    closedToday: false
                },
                shift2: { 
                    id: 2, 
                    name: "Shift 2 (Evening)", 
                    open: false, 
                    openTime: null, 
                    closeTime: null,
                    openedToday: false,
                    closedToday: false
                }
            },
            adminPassword: "super123", // Supervisor password
            history: [],
            currentShift: null
        };

        // DOM Elements
        const elements = {
            shift1Status: document.getElementById('shift1-status'),
            shift2Status: document.getElementById('shift2-status'),
            shift1OpenTime: document.getElementById('shift1-open-time'),
            shift1CloseTime: document.getElementById('shift1-close-time'),
            shift2OpenTime: document.getElementById('shift2-open-time'),
            shift2CloseTime: document.getElementById('shift2-close-time'),
            shift1Today: document.getElementById('shift1-today'),
            shift2Today: document.getElementById('shift2-today'),
            shift1OpenBtn: document.getElementById('shift1-open-btn'),
            shift1CloseBtn: document.getElementById('shift1-close-btn'),
            shift2OpenBtn: document.getElementById('shift2-open-btn'),
            shift2CloseBtn: document.getElementById('shift2-close-btn'),
            historyList: document.getElementById('history-list'),
            currentDate: document.getElementById('current-date'),
            currentShiftIndicator: document.getElementById('current-shift-indicator'),
            currentShiftText: document.getElementById('current-shift-text'),
            passwordModal: document.getElementById('password-modal'),
            passwordInput: document.getElementById('password-input'),
            cancelBtn: document.getElementById('cancel-btn'),
            confirmBtn: document.getElementById('confirm-btn')
        };

        // Initialize the application
        function init() {
            if (typeof firebaseConnected !== 'undefined' && firebaseConnected) {
                loadFromFirebase();
            } else {
                loadFromLocalStorage();
            }
            updateUI();
            setupEventListeners();
            updateCurrentDate();
            checkDayChange();
        }

        // ... All other functions remain exactly the same (openShift, closeShift, handleOpenShift, handleCloseShift, updateUI, history functions, etc.) ...

        // Save state to Firebase
        async function saveToFirebase() {
            if (!firebaseConnected) return;
            try {
                const dataToSave = {
                    shifts: {
                        shift1: {
                            ...state.shifts.shift1,
                            openTime: state.shifts.shift1.openTime ? firebase.firestore.Timestamp.fromDate(state.shifts.shift1.openTime) : null,
                            closeTime: state.shifts.shift1.closeTime ? firebase.firestore.Timestamp.fromDate(state.shifts.shift1.closeTime) : null
                        },
                        shift2: {
                            ...state.shifts.shift2,
                            openTime: state.shifts.shift2.openTime ? firebase.firestore.Timestamp.fromDate(state.shifts.shift2.openTime) : null,
                            closeTime: state.shifts.shift2.closeTime ? firebase.firestore.Timestamp.fromDate(state.shifts.shift2.closeTime) : null
                        }
                    },
                    currentShift: state.currentShift,
                    history: state.history.map(item => ({
                        message: item.message,
                        timestamp: firebase.firestore.Timestamp.fromDate(item.timestamp)
                    }))
                };
                await db.collection("shiftSystem").doc("currentState").set(dataToSave);
                console.log("Data saved to Firebase");
            } catch (error) {
                console.error("Error saving to Firebase:", error);
            }
        }

        // Load state from Firebase
        let shiftListener = null;
        async function loadFromFirebase() {
            if (!firebaseConnected) return;
            try {
                const doc = await db.collection("shiftSystem").doc("currentState").get();
                if (doc.exists) {
                    const data = doc.data();
                    state.shifts.shift1.open = data.shifts.shift1.open;
                    state.shifts.shift1.openTime = data.shifts.shift1.openTime ? data.shifts.shift1.openTime.toDate() : null;
                    state.shifts.shift1.closeTime = data.shifts.shift1.closeTime ? data.shifts.shift1.closeTime.toDate() : null;
                    state.shifts.shift1.openedToday = data.shifts.shift1.openedToday || false;
                    state.shifts.shift1.closedToday = data.shifts.shift1.closedToday || false;

                    state.shifts.shift2.open = data.shifts.shift2.open;
                    state.shifts.shift2.openTime = data.shifts.shift2.openTime ? data.shifts.shift2.openTime.toDate() : null;
                    state.shifts.shift2.closeTime = data.shifts.shift2.closeTime ? data.shifts.shift2.closeTime.toDate() : null;
                    state.shifts.shift2.openedToday = data.shifts.shift2.openedToday || false;
                    state.shifts.shift2.closedToday = data.shifts.shift2.closedToday || false;

                    state.currentShift = data.currentShift || null;
                    state.history = (data.history || []).map(item => ({
                        message: item.message,
                        timestamp: item.timestamp.toDate()
                    }));
                } else {
                    addToHistory("System initialized (no data in Firebase)");
                }

                updateHistoryUI();
                updateUI();

                // Real-time listener for live updates
                if (!shiftListener) {
                    shiftListener = db.collection("shiftSystem").doc("currentState")
                        .onSnapshot(doc => {
                            if (doc.exists) {
                                const data = doc.data();
                                state.shifts.shift1.open = data.shifts.shift1.open;
                                state.shifts.shift1.openTime = data.shifts.shift1.openTime ? data.shifts.shift1.openTime.toDate() : null;
                                state.shifts.shift1.closeTime = data.shifts.shift1.closeTime ? data.shifts.shift1.closeTime.toDate() : null;
                                state.shifts.shift1.openedToday = data.shifts.shift1.openedToday || false;
                                state.shifts.shift1.closedToday = data.shifts.shift1.closedToday || false;

                                state.shifts.shift2.open = data.shifts.shift2.open;
                                state.shifts.shift2.openTime = data.shifts.shift2.openTime ? data.shifts.shift2.openTime.toDate() : null;
                                state.shifts.shift2.closeTime = data.shifts.shift2.closeTime ? data.shifts.shift2.closeTime.toDate() : null;
                                state.shifts.shift2.openedToday = data.shifts.shift2.openedToday || false;
                                state.shifts.shift2.closedToday = data.shifts.shift2.closedToday || false;

                                state.currentShift = data.currentShift || null;

                                state.history = (data.history || []).map(item => ({
                                    message: item.message,
                                    timestamp: item.timestamp.toDate()
                                }));

                                updateHistoryUI();
                                updateUI();
                            }
                        });
                }

            } catch (error) {
                console.error("Error loading from Firebase:", error);
            }
        }

        // Global variable for current action (used in password modal)
        let currentAction = null;

        // Initialize the application when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
