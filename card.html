<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Boarding Pass Parser</title>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; background: #f4f6f9; display:flex; justify-content:center; }
  .container { max-width: 900px; width:100%; display:flex; gap:20px; }
  .scanner { flex:1; background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 12px rgba(0,0,0,0.1); }
  h2 { text-align:center; color: #333; }
  label { display: block; margin-top: 15px; font-weight: bold; }
  input, select { width: 100%; padding: 10px; margin-top: 5px; border:1px solid #ccc; border-radius:6px; }
  .entry { margin-top: 20px; border:1px solid #ccc; padding:20px; border-radius:8px; background-color:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1); }
  .entry-row { display: flex; margin-bottom: 15px; }
  .entry-row label { font-weight: bold; width: 200px; }
  .entry-row .value { font-weight: normal; flex-grow: 1; }
  select.payment-dropdown {
    padding: 6px;
    width: 100%;
    border: 1px solid #999;
    border-radius: 6px;
  }
</style>
</head>
<body>
<div class="container">
  <div class="scanner">
    <h2>QR Boarding Pass Parser</h2>
    <label for="qrInput">Paste QR / Scan Code:</label>
    <input type="text" id="qrInput" placeholder="Paste or scan QR data here" />

    <div id="entriesContainer"></div>
  </div>
</div>

<!-- Firebase Compat Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // --- Firebase init ---
  var firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();

  var qrInput = document.getElementById("qrInput");
  var entriesContainer = document.getElementById("entriesContainer");

  var allEntries = []; // Keep today's entries

  // --- Parse QR ---
  function parseQR(code){
    code = code.trim().toUpperCase().replace(/\s+/g,' ');
    var allParts = code.split(' ');
    var name = "", flightNo = "", seatNo = "", fq = "", paxAdults = 2, paxKids = 1;
    var paymentMethod = "Cash", currencyType = "USD", rateSelector = "Standard";
    var total = 500, paidAmount = 300, balance = total - paidAmount;

    if (code.startsWith("TKVCPO")) {
      var tkIndex = code.indexOf("TK0");
      if (tkIndex !== -1) {
        flightNo = code.substring(tkIndex, tkIndex + 6);
        name = code.substring(6, tkIndex);
      }
      var mlePos = code.indexOf("MLE");
      if (mlePos !== -1) {
        var afterMLE = code.substring(mlePos).split(' ')[0];
        if (afterMLE.length >= 11) seatNo = afterMLE.substring(8, 11);
      }
    } else {
      name = allParts[0].substring(2);
      var mleIndex = allParts.findIndex(w => w.includes("MLE"));
      if (mleIndex !== -1) {
        var mleWord = allParts[mleIndex];
        var nextWord = (mleIndex + 1 < allParts.length) ? allParts[mleIndex + 1] : "";
        flightNo = mleWord.slice(-2) + nextWord;
        var partsAfterMLE = allParts.slice(mleIndex + 1);
        for (let w of partsAfterMLE) {
          if (w.length >= 9 && !w.includes("QR") && !w.includes("MLE")) {
            seatNo = w.substring(5, w.length - 4);
            break;
          }
        }
      }
    }

    return {
      name: name || "-",
      flightNo: flightNo || "-",
      seatNo: seatNo || "-",
      paxAdults,
      paxKids,
      paymentMethod,
      currencyType,
      rateSelector,
      total,
      paidAmount,
      balance
    };
  }

  // --- Display entries ---
  function displayEntries(){
    entriesContainer.innerHTML = '';
    allEntries.forEach(function(d, index) {
      var entryDiv = document.createElement("div");
      entryDiv.classList.add("entry");

      const dropdownId = `payment-method-${index}`;
      entryDiv.innerHTML = `
        <div class="entry-row"><label>Name:</label><div class="value">${d.name}</div></div>
        <div class="entry-row"><label>Date:</label><div class="value">${d.date}</div></div>
        <div class="entry-row"><label>Flight No:</label><div class="value">${d.flightNo}</div></div>
        <div class="entry-row"><label>Seat No:</label><div class="value">${d.seatNo}</div></div>
        <div class="entry-row"><label>No. of Pax (Adults):</label><div class="value">${d.paxAdults}</div></div>
        <div class="entry-row"><label>No. of Pax (Kids):</label><div class="value">${d.paxKids}</div></div>
        <div class="entry-row">
          <label>Payment Method:</label>
          <div class="value">
            <select class="payment-dropdown" id="${dropdownId}">
              <option ${d.paymentMethod === 'Cash' ? 'selected' : ''}>Cash</option>
              <option ${d.paymentMethod === 'Card' ? 'selected' : ''}>Card</option>
              <option ${d.paymentMethod === 'Amex' ? 'selected' : ''}>Amex</option>
              <option ${d.paymentMethod === 'Visa' ? 'selected' : ''}>Visa</option>
              <option ${d.paymentMethod === 'Master' ? 'selected' : ''}>Master</option>
            </select>
          </div>
        </div>
        <div class="entry-row"><label>Currency Type:</label><div class="value">${d.currencyType}</div></div>
        <div class="entry-row"><label>Rate Selector:</label><div class="value">${d.rateSelector}</div></div>
        <div class="entry-row"><label>Total:</label><div class="value">${d.total}</div></div>
        <div class="entry-row"><label>Paid Amount:</label><div class="value">${d.paidAmount}</div></div>
        <div class="entry-row"><label>Balance:</label><div class="value">${d.balance}</div></div>
      `;

      entriesContainer.appendChild(entryDiv);

      // Optional: Update Firestore on dropdown change
      const selectEl = entryDiv.querySelector(`#${dropdownId}`);
      selectEl.addEventListener("change", () => {
        const newMethod = selectEl.value;
        const docRef = d._docRef;
        if (docRef) {
          docRef.update({ paymentMethod: newMethod });
        }
      });
    });
  }

  // --- Load today's entries ---
  function loadTodayEntries() {
    var today = new Date().toISOString().split("T")[0];
    db.collection("qr_entries").where("date", "==", today)
      .onSnapshot(function(snapshot) {
        allEntries = [];
        snapshot.forEach(function(doc) {
          var d = doc.data();
          d._docRef = doc.ref; // So we can update later
          allEntries.push(d);
        });
        displayEntries();
      });
  }

  // --- On QR input ---
  qrInput.addEventListener("input", function() {
    var code = qrInput.value.trim();
    if (!code) return;

    var parsed = parseQR(code);
    var today = new Date().toISOString().split("T")[0];

    db.collection("qr_entries").add({ ...parsed, date: today })
      .then(() => { qrInput.value = ""; })
      .catch(err => console.error("Error saving QR:", err));
  });

  // --- Init ---
  loadTodayEntries();
</script>
</body>
</html>
