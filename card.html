<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Booking Form</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f6f9; margin: 20px; }
  h2 { text-align: center; color: #333; }
  form { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, select, button { padding: 8px; width: 100%; margin-top: 5px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
  .readonly-field { background: #f0f0f0; }
  .hidden { display: none; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
  .full-width { grid-column: 1 / -1; }
  .totals, .cash-section { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
  button { width: 100%; background: #007bff; color: white; font-size: 1rem; cursor: pointer; margin-top: 20px; }
  button:hover { background: #0056b3; }
</style>
</head>
<body>

<h2>Booking Entry</h2>

<form id="bookingForm">
  <label for="qrInput">Scan/Paste QR Code (optional):</label>
  <input type="text" id="qrInput" placeholder="Paste or scan QR code here" class="full-width">

  <div class="form-grid">
    <div>
      <label>Date:</label>
      <input type="date" id="date">
      <label>Name:</label>
      <input type="text" id="name">
      <label>Flight No:</label>
      <input type="text" id="flight">
      <label>Seat No:</label>
      <input type="text" id="seat">
    </div>

    <div>
      <label>Currency:</label>
      <select id="currencyType">
        <option value="USD">USD</option>
        <option value="MVR">MVR</option>
      </select>
      <label>Rate:</label>
      <select id="rateType">
        <option value="A" selected>Rate A</option>
        <option value="B">Rate B</option>
      </select>
      <label>Adults:</label>
      <input type="number" id="adultCount" value="0" min="0">
      <label>Kids:</label>
      <input type="number" id="kidCount" value="0" min="0">
    </div>

    <div class="full-width">
      <label>Payment Type:</label>
      <select id="paymentType">
        <option value="Cash">Cash</option>
        <option value="Card">Card</option>
      </select>

      <div id="cashFields" class="cash-section hidden">
        <div>
          <label>Given Amount:</label>
          <input type="number" id="givenAmount" min="0" step="0.01">
        </div>
        <div>
          <label>Balance:</label>
          <input type="text" id="balanceField" class="readonly-field" readonly>
        </div>
      </div>

      <label>Receipt No:</label>
      <input type="text" id="receiptNo" readonly>
    </div>
  </div>

  <div class="totals">
    <div>
      <label>Total Adults:</label>
      <input type="text" id="totalAdults" class="readonly-field" readonly>
    </div>
    <div>
      <label>Total Kids:</label>
      <input type="text" id="totalKids" class="readonly-field" readonly>
    </div>
    <div>
      <label>GST:</label>
      <input type="text" id="gstField" class="readonly-field" readonly>
    </div>
    <div>
      <label>Total:</label>
      <input type="text" id="totalField" class="readonly-field" readonly>
    </div>
  </div>

  <button type="button" id="saveBtn">Save Entry</button>
</form>

<div id="output" style="max-width:900px;margin:20px auto;"></div>

<script src="rate.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire1.js"></script>

<script>
const dateField = document.getElementById("date");
const qrInput = document.getElementById("qrInput");
const nameField = document.getElementById("name");
const flightField = document.getElementById("flight");
const seatField = document.getElementById("seat");
const currencyType = document.getElementById("currencyType");
const rateType = document.getElementById("rateType");
const adultCount = document.getElementById("adultCount");
const kidCount = document.getElementById("kidCount");
const paymentType = document.getElementById("paymentType");
const givenAmount = document.getElementById("givenAmount");
const balanceField = document.getElementById("balanceField");
const cashFields = document.getElementById("cashFields");
const receiptNo = document.getElementById("receiptNo");
const totalAdultsField = document.getElementById("totalAdults");
const totalKidsField = document.getElementById("totalKids");
const gstField = document.getElementById("gstField");
const totalField = document.getElementById("totalField");
const outputDiv = document.getElementById("output");

dateField.value = new Date().toISOString().split('T')[0];

function toggleCashFields(){
  cashFields.style.display = paymentType.value === "Cash" ? "grid" : "none";
}

function calculate(){
  const curr = currencyType.value;
  const rate = rateType.value;
  const adults = parseInt(adultCount.value)||0;
  const kids = parseInt(kidCount.value)||0;
  const adultKey = `Adult${rate}${curr}`;
  const kidKey = `Kids${rate}${curr}`;
  const adultRate = rates[adultKey].price;
  const kidRate = rates[kidKey].price;
  const gstPercent = rates[adultKey].GST;
  const totalAdults = adults*adultRate;
  const totalKids = kids*kidRate;
  const subtotal = totalAdults+totalKids;
  const gstAmount = subtotal*(gstPercent/100);
  const total = subtotal+gstAmount;
  totalAdultsField.value = totalAdults.toFixed(2);
  totalKidsField.value = totalKids.toFixed(2);
  gstField.value = gstAmount.toFixed(2);
  totalField.value = total.toFixed(2);
  if(paymentType.value==="Cash"){
    const given = parseFloat(givenAmount.value)||0;
    balanceField.value = (given-total).toFixed(2);
  } else balanceField.value="";
  return {subtotal, gstAmount, total};
}

paymentType.addEventListener("change", ()=>{
  toggleCashFields();
  calculate();
});

[currencyType, rateType, adultCount, kidCount, givenAmount].forEach(el=>{
  el.addEventListener("input",calculate);
  el.addEventListener("change",calculate);
});

window.addEventListener("DOMContentLoaded",()=>{
  toggleCashFields();
  calculate();
});

// Get next receipt number safely
async function getNextReceiptNo(){
  const counterRef = db.collection("counters").doc("receiptNo");
  try{
    const nextReceiptNo = await db.runTransaction(async (transaction)=>{
      const doc = await transaction.get(counterRef);
      let current = 0;
      if(!doc.exists){
        transaction.set(counterRef, {current: 1});
        current = 1;
      } else {
        current = doc.data().current + 1;
        transaction.update(counterRef, {current: current});
      }
      return current;
    });
    return nextReceiptNo;
  } catch(err){
    console.error("Error getting next receipt number:", err);
    return 1;
  }
}

// Function to generate receipt HTML
function generateReceiptHTML(data){
  let html = `
    <h2>Company Name</h2>
    <h3>Cash Receipt</h3>
    <div style="border-top:1px dashed #000;margin:5px 0;"></div>
    <div style="display:flex;justify-content:space-between;"><span>Receipt No:</span><span>${data.receiptNo}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Date:</span><span>${data.date}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Name:</span><span>${data.name}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Flight:</span><span>${data.flight}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Seat:</span><span>${data.seat}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Payment:</span><span>${data.paymentType}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Currency:</span><span>${data.currency}</span></div>
    <div style="border-top:1px dashed #000;margin:5px 0;"></div>
    <div style="display:flex;justify-content:space-between;"><span>Adults:</span><span>${data.adults}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Kids:</span><span>${data.kids}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>GST:</span><span>${data.gst.toFixed(2)}</span></div>
    <div style="display:flex;justify-content:space-between;"><span>Total:</span><span>${data.total.toFixed(2)}</span></div>
  `;
  if(data.paymentType === "Cash"){
    html += `
      <div style="display:flex;justify-content:space-between;"><span>Given:</span><span>${data.givenAmount.toFixed(2)}</span></div>
      <div style="display:flex;justify-content:space-between;"><span>Balance:</span><span>${data.balance.toFixed(2)}</span></div>
    `;
  }
  html += `
    <div style="border-top:1px dashed #000;margin:5px 0;"></div>
    <p style="text-align:center;font-weight:bold;">This package is valid for 3 hours</p>
    <p style="text-align:center;">Thank you for your payment!</p>
  `;
  return html;
}

document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const totals = calculate();
  const newReceiptNo = await getNextReceiptNo();
  receiptNo.value = newReceiptNo;

  const data = {
    date: dateField.value,
    qrCode: qrInput.value || null,
    name: nameField.value,
    flight: flightField.value,
    seat: seatField.value,
    currency: currencyType.value,
    rate: rateType.value,
    adults: parseInt(adultCount.value) || 0,
    kids: parseInt(kidCount.value) || 0,
    paymentType: paymentType.value,
    givenAmount: paymentType.value === "Cash" ? parseFloat(givenAmount.value) || 0 : null,
    balance: paymentType.value === "Cash" ? parseFloat(balanceField.value) || 0 : null,
    receiptNo: newReceiptNo,
    totalAdults: parseFloat(totalAdultsField.value),
    totalKids: parseFloat(totalKidsField.value),
    gst: parseFloat(gstField.value),
    total: parseFloat(totalField.value),
    timestamp: new Date()
  };

  try{
    await db.collection("bookings").add(data);
    outputDiv.innerHTML = `<p style="color:green;">Booking saved successfully!</p>`;

    // Ask how many copies to print
    let copies = prompt("How many receipts to print?", "1");
    copies = parseInt(copies) || 1;

    const receiptHTML = generateReceiptHTML(data);
    for(let i=0;i<copies;i++){
      const printWindow = window.open('','_blank');
      printWindow.document.write(receiptHTML);
      printWindow.document.close();
      printWindow.print();
    }

    document.getElementById("bookingForm").reset();
    dateField.value = new Date().toISOString().split('T')[0];
    toggleCashFields();
    calculate();

  } catch(err){
    console.error("Error saving booking:", err);
    outputDiv.innerHTML = `<p style="color:red;">Error saving booking: ${err.message}</p>`;
  }
});
</script>
</body>
</html>
