<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Sales Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Include your Firebase config -->
<script src="fire2.js"></script>
<style>
  :root {
    --light: #f8f9fa;
    --dark: #212529;
    --gray: #6c757d;
    --border: #dee2e6;
    --shadow: 0 4px 10px rgba(0,0,0,0.1);
    --radius: 4px;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f5f5;
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  .header {
    text-align: center;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid #ddd;
  }

  .header h1 {
    font-weight: 700;
    margin-bottom: 5px;
    font-size: 24px;
    color: #000;
  }

  .header p {
    color: var(--gray);
    font-size: 14px;
  }

  .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid #ddd;
  }

  .date-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .date-control label {
    font-weight: 600;
    color: #000;
  }

  .date-control input {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: var(--radius);
    font-size: 14px;
  }

  .date-control input:focus {
    outline: none;
    border-color: #666;
  }

  .btn {
    padding: 8px 16px;
    background: #555;
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
  }

  .btn:hover {
    background: #333;
  }

  .btn-print {
    background: #777;
  }

  .btn-print:hover {
    background: #555;
  }

  .report-container {
    background: white;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 30px;
    display: none;
    border: 1px solid #ddd;
  }

  .report-header {
    background: #f0f0f0;
    color: #000;
    padding: 15px 20px;
    text-align: center;
    border-bottom: 1px solid #ddd;
  }

  .report-header h2 {
    margin-bottom: 5px;
    font-weight: 700;
    font-size: 20px;
  }

  .report-header p {
    font-size: 14px;
  }

  .report-body {
    padding: 20px;
  }

  .report-section {
    margin-bottom: 25px;
  }

  .report-section h3 {
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid #ddd;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    color: #000;
  }

  .report-section h3 i {
    font-size: 16px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    font-size: 13px;
    border: 1px solid #ddd;
  }

  th, td {
    padding: 10px 12px;
    text-align: left;
    border: 1px solid #ddd;
  }

  th {
    background: #f0f0f0;
    font-weight: 600;
    color: #000;
  }

  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 25px;
  }

  .summary-card {
    background: white;
    border-radius: var(--radius);
    border: 1px solid #ddd;
    padding: 15px;
    text-align: center;
  }

  .summary-card h4 {
    color: #666;
    margin-bottom: 8px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .summary-card .value {
    font-size: 20px;
    font-weight: 700;
    color: #000;
  }

  .summary-card .currency {
    font-size: 12px;
    color: #666;
    margin-left: 4px;
  }

  .voided-row {
    background-color: #f9f9f9;
  }

  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
  }

  .status-active {
    background: #f0f0f0;
    color: #000;
    border: 1px solid #ddd;
  }

  .status-voided {
    background: #f0f0f0;
    color: #000;
    border: 1px solid #ddd;
  }

  .loading {
    text-align: center;
    padding: 25px;
    color: #666;
  }

  .empty-state {
    text-align: center;
    padding: 30px;
    color: #666;
  }

  .empty-state i {
    font-size: 36px;
    margin-bottom: 10px;
    color: #ddd;
  }

  @media (max-width: 768px) {
    .controls {
      flex-direction: column;
    }
    
    .date-control {
      flex-direction: column;
      width: 100%;
    }
    
    .summary-cards {
      grid-template-columns: 1fr;
    }
    
    table {
      font-size: 12px;
    }
    
    th, td {
      padding: 8px 10px;
    }
  }

  @media print {
    body {
      background: white;
      padding: 0;
      font-size: 12px;
    }
    
    .container {
      max-width: 100%;
    }
    
    .header, .controls {
      display: none;
    }
    
    .report-container {
      display: block !important;
      box-shadow: none;
      margin: 0;
      border: none;
    }
    
    .report-header {
      border-bottom: 1px solid #000;
    }
    
    table {
      page-break-inside: avoid;
    }
    
    .summary-cards {
      page-break-inside: avoid;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 id="companyName">Daily Sales Report</h1>
    <p>Generate and view daily sales reports</p>
  </div>

  <div class="controls">
    <div class="date-control">
      <label for="reportDate"><i class="fas fa-calendar-alt"></i> Select Date:</label>
      <input type="date" id="reportDate">
    </div>
    <button id="generateBtn" class="btn">
      <i class="fas fa-chart-line"></i> Generate Report
    </button>
    <button onclick="printReport()" class="btn btn-print">
      <i class="fas fa-print"></i> Print Report
    </button>
  </div>

  <div class="report-container" id="reportContainer">
    <div class="report-header">
      <h2 id="reportTitle">Daily Sales Report</h2>
      <p id="reportDateText"></p>
    </div>

    <div class="report-body">
      <div class="summary-cards" id="summaryCards">
        <!-- Summary cards will be inserted here by JavaScript -->
      </div>

      <div class="report-section">
        <h3><i class="fas fa-receipt"></i> Active Receipts</h3>
        <table id="receiptsTable">
          <thead>
            <tr>
              <th>Receipt No</th>
              <th>Flight No</th>
              <th>Payment Type</th>
              <th>Currency</th>
              <th>Total Amount</th>
              <th>Batch No</th>
              <th>Approval Code</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="report-section">
        <h3><i class="fas fa-times-circle"></i> Voided Receipts</h3>
        <table id="voidedTable">
          <thead>
            <tr>
              <th>Receipt No</th>
              <th>Payment Type</th>
              <th>Currency</th>
              <th>Total Amount</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Initialize Firebase
let db;
try {
  // Check if firebaseConfig is available from fire2.js
  if (typeof firebaseConfig !== 'undefined') {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase initialized successfully");
  } else {
    throw new Error("Firebase configuration not found");
  }
} catch (error) {
  console.error("Firebase initialization error:", error);
  // Fallback to demo mode
  initDemoMode();
}

function initDemoMode() {
  console.log("Initializing demo mode");
  db = {
    collection: (name) => {
      return {
        where: (field, operator, value) => {
          return {
            get: () => {
              // Sample data for demonstration
              const sampleData = [
                {
                  id: '1',
                  data: () => ({
                    receiptNo: '1001',
                    flight: 'TK123',
                    paymentType: 'Cash',
                    currency: 'USD',
                    total: 150.00,
                    batchNo: '',
                    approvalCode: '',
                    status: 'Active',
                    timestamp: new Date()
                  })
                },
                {
                  id: '2',
                  data: () => ({
                    receiptNo: '1002',
                    flight: 'QR456',
                    paymentType: 'Visa',
                    currency: 'USD',
                    total: 200.00,
                    batchNo: 'B123',
                    approvalCode: 'A456',
                    status: 'Active',
                    timestamp: new Date()
                  })
                },
                {
                  id: '3',
                  data: () => ({
                    receiptNo: '1003',
                    flight: 'EK789',
                    paymentType: 'Cash',
                    currency: 'USD',
                    total: 175.50,
                    batchNo: '',
                    approvalCode: '',
                    status: 'Voided',
                    voided: true,
                    voidReason: 'Customer cancellation',
                    timestamp: new Date()
                  })
                },
                {
                  id: '4',
                  data: () => ({
                    receiptNo: '1004',
                    flight: 'SQ012',
                    paymentType: 'MasterCard',
                    currency: 'USD',
                    total: 225.75,
                    batchNo: 'B789',
                    approvalCode: 'A012',
                    status: 'Active',
                    timestamp: new Date()
                  })
                },
                {
                  id: '5',
                  data: () => ({
                    receiptNo: '1005',
                    flight: 'CX345',
                    paymentType: 'Amex',
                    currency: 'USD',
                    total: 190.00,
                    batchNo: 'B345',
                    approvalCode: 'A678',
                    status: 'Active',
                    timestamp: new Date()
                  })
                }
              ];
              
              // Filter data based on the query
              let filteredData = sampleData;
              
              // If this is a date range query, filter by date
              if (field === 'timestamp') {
                const selectedDate = document.getElementById('reportDate').value;
                const start = new Date(selectedDate + "T00:00:00");
                const end = new Date(selectedDate + "T23:59:59");
                
                filteredData = sampleData.filter(item => {
                  const itemDate = item.data().timestamp;
                  return itemDate >= start && itemDate <= end;
                });
              }
              
              return Promise.resolve({
                docs: filteredData,
                forEach: (callback) => {
                  filteredData.forEach(doc => callback(doc));
                }
              });
            }
          };
        }
      };
    }
  };
}

// Set company name
document.getElementById("companyName").innerText = "Lounge Management System";

const reportDateInput = document.getElementById("reportDate");
const generateBtn = document.getElementById("generateBtn");
const reportContainer = document.getElementById("reportContainer");
const reportTitle = document.getElementById("reportTitle");
const reportDateText = document.getElementById("reportDateText");
const summaryCards = document.getElementById("summaryCards");
const receiptsTableBody = document.querySelector("#receiptsTable tbody");
const voidedTableBody = document.querySelector("#voidedTable tbody");

// Set default date to today
const today = new Date();
reportDateInput.value = today.toISOString().split('T')[0];

generateBtn.addEventListener("click", async () => {
  const selectedDate = reportDateInput.value;
  if(!selectedDate) return alert("Select a valid date");

  reportContainer.style.display = "block";
  reportTitle.innerText = `Daily Sales Report`;
  reportDateText.innerText = `Date: ${formatDate(selectedDate)}`;

  try {
    // Show loading state
    receiptsTableBody.innerHTML = '<tr><td colspan="8" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading data...</td></tr>';
    voidedTableBody.innerHTML = '';
    summaryCards.innerHTML = '';

    const start = new Date(selectedDate + "T00:00:00");
    const end = new Date(selectedDate + "T23:59:59");

    // Get data from Firebase
    const snapshot = await db.collection("bookings")
      .where("timestamp", ">=", start)
      .where("timestamp", "<=", end)
      .get();

    let totalsCashByCurrency = {};
    let totalsNonCashByTypeCurrency = {};
    let voidedByTypeCurrency = {};
    let totalActive = 0;
    let totalVoided = 0;

    receiptsTableBody.innerHTML = "";
    voidedTableBody.innerHTML = "";
    summaryCards.innerHTML = "";

    // Process each document
    snapshot.forEach(doc => {
      const data = doc.data();

      const key = `${data.paymentType} (${data.currency})`;

      if(data.voided || data.status === "Voided"){
        totalVoided++;
        
        // Voided totals to subtract later
        if(data.paymentType.toLowerCase() === "cash"){
          if(!voidedByTypeCurrency[data.currency]) voidedByTypeCurrency[data.currency] = 0;
          voidedByTypeCurrency[data.currency] += data.total;
        } else {
          if(!voidedByTypeCurrency[key]) voidedByTypeCurrency[key] = 0;
          voidedByTypeCurrency[key] += data.total;
        }

        const tr = document.createElement("tr");
        tr.className = "voided-row";
        tr.innerHTML = `
          <td>${data.receiptNo}</td>
          <td>${data.paymentType}</td>
          <td>${data.currency}</td>
          <td>${data.total.toFixed(2)}</td>
          <td>${data.voidReason || 'Customer cancellation'}</td>
        `;
        voidedTableBody.appendChild(tr);

      } else {
        totalActive++;
        
        // Active receipts table
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.receiptNo}</td>
          <td>${data.flight || '-'}</td>
          <td>${data.paymentType}</td>
          <td>${data.currency}</td>
          <td>${data.total.toFixed(2)}</td>
          <td>${data.batchNo || '-'}</td>
          <td>${data.approvalCode || '-'}</td>
          <td><span class="status-badge status-active">Active</span></td>
        `;
        receiptsTableBody.appendChild(tr);

        if(data.paymentType.toLowerCase() === "cash"){
          if(!totalsCashByCurrency[data.currency]) totalsCashByCurrency[data.currency] = 0;
          totalsCashByCurrency[data.currency] += data.total;
        } else {
          if(!totalsNonCashByTypeCurrency[key]) totalsNonCashByTypeCurrency[key] = 0;
          totalsNonCashByTypeCurrency[key] += data.total;
        }
      }
    });

    // Subtract voided amounts
    for(const curr in totalsCashByCurrency){
      if(voidedByTypeCurrency[curr]) totalsCashByCurrency[curr] -= voidedByTypeCurrency[curr];
    }
    for(const key in totalsNonCashByTypeCurrency){
      if(voidedByTypeCurrency[key]) totalsNonCashByTypeCurrency[key] -= voidedByTypeCurrency[key];
    }

    // Build summary cards
    summaryCards.innerHTML = `
      <div class="summary-card">
        <h4>Active Receipts</h4>
        <div class="value">${totalActive}</div>
      </div>
      <div class="summary-card">
        <h4>Voided Receipts</h4>
        <div class="value">${totalVoided}</div>
      </div>
    `;

    // Add currency summary cards
    for(const curr in totalsCashByCurrency){
      if(totalsCashByCurrency[curr] > 0) {
        summaryCards.innerHTML += `
          <div class="summary-card">
            <h4>Cash (${curr})</h4>
            <div class="value">${totalsCashByCurrency[curr].toFixed(2)}<span class="currency">${curr}</span></div>
          </div>
        `;
      }
    }

    for(const key in totalsNonCashByTypeCurrency){
      if(totalsNonCashByTypeCurrency[key] > 0) {
        const [type, currency] = key.split(' (');
        const curr = currency.replace(')', '');
        summaryCards.innerHTML += `
          <div class="summary-card">
            <h4>${type} (${curr})</h4>
            <div class="value">${totalsNonCashByTypeCurrency[key].toFixed(2)}<span class="currency">${curr}</span></div>
          </div>
        `;
      }
    }

    // Show empty state if no data
    if (totalActive === 0 && totalVoided === 0) {
      receiptsTableBody.innerHTML = '<tr><td colspan="8" class="empty-state"><i class="fas fa-receipt"></i><p>No receipts found for this date</p></td></tr>';
    }

  } catch(err){
    console.error("Error generating report:", err);
    receiptsTableBody.innerHTML = '<tr><td colspan="8" style="color: #dc3545; text-align: center;">Error loading data: ' + err.message + '</td></tr>';
  }
});

function printReport(){
  window.print();
}

function formatDate(dateString) {
  const options = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(dateString).toLocaleDateString(undefined, options);
}
</script>
</body>
</html>
