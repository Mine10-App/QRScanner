<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    text-align: center;
  }
  h1 { margin-top: 10px; }
  #camera {
    width: 100vw;
    height: 80vh;
    background: #000;
  }
  #info {
    margin: 10px;
    font-size: 18px;
    color: green;
  }
</style>
</head>
<body>

<h1>QR Scanner</h1>
<video id="camera" autoplay playsinline></video>
<div id="info">Point your camera at a QR code</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
  // ===== Firebase config =====
  const firebaseConfig = {
            apiKey: "AIzaSyC9FuNjWn8Up4JyjYbABEF2aNjO2bSXdfM",
            authDomain: "qr-scanner-4458e.firebaseapp.com",
            projectId: "qr-scanner-4458e",
            storageBucket: "qr-scanner-4458e.firebasestorage.app",
            messagingSenderId: "1099262112748",
            appId: "1:1099262112748:web:a18f206bcf893c894546c9",
            measurementId: "G-15WXNEPKS9"
        };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== Access camera =====
  const video = document.getElementById('camera');

  navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
  }).then(stream => {
    video.srcObject = stream;
  }).catch(err => {
    console.error('Camera error:', err);
  });

  // ===== QR scanning =====
  function scanFrame() {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    const code = jsQR(imageData.data, imageData.width, imageData.height);
    if (code) {
      saveScan(code.data);
    }
    requestAnimationFrame(scanFrame);
  }

  // ===== Save scan to Firebase =====
  const scannedCodes = new Set(); // avoid duplicate saves
  function saveScan(data) {
    if (scannedCodes.has(data)) return;
    scannedCodes.add(data);
    db.collection('scans').add({ text: data, time: new Date() })
      .then(() => document.getElementById('info').textContent = 'Scanned: ' + data)
      .catch(err => console.error(err));
  }

  // Start scanning when video is ready
  video.onloadedmetadata = () => {
    scanFrame();
  };
</script>

</body>
</html>
