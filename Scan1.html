<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ZXing Barcode Scanner with Firebase</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video { width: 100%; max-width: 500px; border: 2px solid #333; border-radius: 8px; }
    ul { list-style: none; padding: 0; margin-top: 20px; }
    li { padding: 8px; background: #eee; margin: 5px 0; border-radius: 5px; }
    #message { margin-top: 15px; font-weight: bold; color: red; }
    button { padding: 10px 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ZXing Barcode Scanner</h2>
  <video id="video" autoplay></video>
  <div id="message"></div>
  <button id="saveBtn" disabled>Save Barcode</button>
  <ul id="scannedData"></ul>

<script>
  // ===== FIREBASE CONFIG =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5G36djlzBuhNEzKzrvcJ_1-qvrTm1bOs",
    authDomain: "qr-scanner-live-5b385.firebaseapp.com",
    projectId: "qr-scanner-live-5b385",
    storageBucket: "qr-scanner-live-5b385.firebasestorage.app",
    messagingSenderId: "260207453177",
    appId: "1:260207453177:web:ea438ade7b1b56270e1328",
    measurementId: "G-WQEEHEPWG3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const video = document.getElementById("video");
  const messageDiv = document.getElementById("message");
  const saveBtn = document.getElementById("saveBtn");
  const scannedDataList = document.getElementById("scannedData");

  let currentCode = "";
  const existingCodes = new Set();

  // Load existing codes from Firebase
  db.collection("scans").get().then(snapshot => {
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.code) existingCodes.add(data.code);
    });
  });

  function showMessage(text) {
    messageDiv.textContent = text;
    setTimeout(() => { messageDiv.textContent = ""; }, 2000);
  }

  function saveCurrentCode() {
    if (!currentCode) return;
    if (!existingCodes.has(currentCode)) {
      existingCodes.add(currentCode);
      db.collection("scans").add({
        code: currentCode,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        copied: false
      });
      const li = document.createElement("li");
      li.textContent = currentCode + " (" + new Date().toLocaleString() + ")";
      scannedDataList.prepend(li);
      saveBtn.disabled = true;
      currentCode = "";
    } else {
      showMessage("Code already exists in Firebase.");
    }
  }
  saveBtn.addEventListener("click", saveCurrentCode);

  // ===== ZXING SCANNER =====
  const codeReader = new ZXing.BrowserMultiFormatReader();

  codeReader
    .listVideoInputDevices()
    .then(videoInputDevices => {
      // pick back camera if available
      let selectedDeviceId = videoInputDevices[0].deviceId;
      for (const cam of videoInputDevices) {
        if (cam.label.toLowerCase().includes("back") || cam.label.toLowerCase().includes("rear")) {
          selectedDeviceId = cam.deviceId;
          break;
        }
      }

      codeReader.decodeFromVideoDevice(selectedDeviceId, video, result => {
        if (result) {
          currentCode = result.text;
          if (existingCodes.has(currentCode)) {
            showMessage("Match: Code is in the system");
            saveBtn.disabled = true;
          } else {
            saveBtn.disabled = false;
          }
        }
      });
    })
    .catch(err => console.error(err));
</script>
</body>
</html>
