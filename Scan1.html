<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QuaggaJS Auto-Scan Barcode Scanner</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
<style>
  body { font-family: sans-serif; text-align:center; padding:20px; background:white; }
  #video-container { position:relative; display:inline-block; width:100%; max-width:400px; margin-top:20px; }
  video { width:100%; border:2px solid black; border-radius:8px; }
  #scan-line { position:absolute; top:0; left:0; width:100%; height:2px; background:red; animation:scan 2s linear infinite; }
  @keyframes scan {0%{top:0;}50%{top:95%;}100%{top:0;}}
  select, button { padding:8px 16px; margin:10px; font-size:16px; }
  #message { margin-top:15px; font-weight:bold; color:green; }
  ul { list-style:none; padding:0; margin-top:20px; max-width:400px; margin:auto; }
  li { padding:8px; background:#eee; margin:5px 0; border-radius:5px; }
</style>
</head>
<body>

<h2>QuaggaJS Auto-Scan Barcode Scanner</h2>

<select id="cameraSelect"></select>
<button onclick="switchCamera()">Switch Camera</button>

<div id="video-container">
  <video id="video" autoplay muted playsinline></video>
  <div id="scan-line"></div>
</div>

<div id="message">Initializing...</div>
<ul id="scannedData"></ul>
<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyC5G36djlzBuhNEzKzrvcJ_1-qvrTm1bOs",
    authDomain: "qr-scanner-live-5b385.firebaseapp.com",
    projectId: "qr-scanner-live-5b385",
    storageBucket: "qr-scanner-live-5b385.firebasestorage.app",
    messagingSenderId: "260207453177",
    appId: "1:260207453177:web:ea438ade7b1b56270e1328",
    measurementId: "G-WQEEHEPWG3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const video = document.getElementById("video");
  const cameraSelect = document.getElementById("cameraSelect");
  const messageDiv = document.getElementById("message");
  const scannedDataList = document.getElementById("scannedData");
  const beep = document.getElementById("beep");

  let currentCameraId = null;
  const existingCodes = new Set();

  function showMessage(text){
    messageDiv.textContent = text;
    setTimeout(()=>{ messageDiv.textContent = ""; },2000);
  }

  function handleBarcode(code){
    if(!existingCodes.has(code)){
      existingCodes.add(code);
      beep.play();
      flashScreen();
      db.collection("scans").add({
        code: code,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      showMessage("✅ Saved: "+code);
    } else {
      showMessage("⚠ Already exists: "+code);
    }
  }

  function flashScreen(){
    document.body.style.background="#ffff99";
    setTimeout(()=>{document.body.style.background="white";},100);
  }

  // ===== Real-time Firebase Listener =====
  db.collection("scans").orderBy("timestamp","desc").onSnapshot(snapshot=>{
    scannedDataList.innerHTML="";
    existingCodes.clear();
    snapshot.forEach(doc=>{
      const data = doc.data();
      if(data.code){
        existingCodes.add(data.code);
        const li=document.createElement("li");
        const time = data.timestamp?.toDate().toLocaleString() || "No time";
        li.textContent = data.code + " (" + time + ")";
        scannedDataList.appendChild(li);
      }
    });
  });

  // ===== Camera Setup and Scanning =====
  function startScanner(cameraId){
    if(Quagga.running) Quagga.stop();
    currentCameraId = cameraId;
    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: video,
        constraints: {
          deviceId: cameraId,
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      },
      decoder: {
        readers: [
          "code_128_reader",
          "ean_reader",
          "ean_8_reader",
          "upc_reader",
          "upc_e_reader",
          "i2of5_reader",
          "2of5_reader",
          "code_39_reader",
          "code_93_reader",
          "codabar_reader"
        ],
        multiple: false
      },
      locate: true,
      numOfWorkers: navigator.hardwareConcurrency || 4
    }, function(err){
      if(err){ console.error(err); showMessage("Camera init failed"); return; }
      Quagga.start();
      showMessage("Scanning...");
    });

    Quagga.onDetected(result=>{
      if(result && result.codeResult){
        handleBarcode(result.codeResult.code);
      }
    });
  }

  function switchCamera(){
    startScanner(cameraSelect.value);
  }
  window.switchCamera = switchCamera;

  // ===== Request Permission & Populate Camera Dropdown =====
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      // Stop this temporary stream; we only needed permission
      stream.getTracks().forEach(track => track.stop());

      // Now enumerate devices
      return navigator.mediaDevices.enumerateDevices();
    })
    .then(devices => {
      const videoDevices = devices.filter(d => d.kind === "videoinput");
      if(videoDevices.length === 0){
        showMessage("No camera found!");
        return;
      }
      videoDevices.forEach((device,i)=>{
        const option = document.createElement("option");
        option.value = device.deviceId;
        option.text = device.label || `Camera ${i+1}`;
        cameraSelect.appendChild(option);
      });

      // Start with first camera
      startScanner(cameraSelect.options[0].value);
    })
    .catch(err => {
      console.error(err);
      showMessage("Camera permission denied or no camera found!");
    });

</script>

</body>
</html>
